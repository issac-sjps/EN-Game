<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂñÆÂ≠óÈ©óÊî∂ - ÈÅ∏ÊìáÈ°åÊ®ôË®òÁâà</title>
    <style>
        :root { 
            --primary: #4a90e2; 
            --success: #48bb78; 
            --error: #f56565; 
            --bg: #f7fafc; 
            --dark: #2d3748; 
        }
        body { font-family: 'PingFang TC', sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; margin: 0; min-height: 100vh; }
        .card { background: white; width: 100%; max-width: 550px; padding: 30px; border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); text-align: center; position: relative; }
        
        .header-info { margin-bottom: 25px; border-bottom: 2px solid #edf2f7; padding-bottom: 20px; }
        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; font-size: 15px; }
        .stat-box { background: #f8fafc; padding: 10px; border-radius: 12px; border: 1px solid #e2e8f0; }
        .stat-val { font-weight: 800; color: var(--primary); font-size: 18px; }

        .prog-bar-bg { background: #e2e8f0; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 15px; }
        #prog-fill { background: var(--success); width: 0%; height: 100%; transition: width 0.5s; }

        .stage-tag { background: #ebf8ff; color: var(--primary); padding: 6px 20px; border-radius: 50px; font-size: 14px; font-weight: bold; display: inline-block; margin-bottom: 15px; }
        .hint-cn { font-size: 42px; font-weight: 800; margin: 20px 0; color: var(--dark); }

        /* ÈÅ∏ÊìáÈ°åÊ®£Âºè */
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin: 25px 0; }
        .opt-btn { padding: 20px; border: 2px solid #e2e8f0; background: white; border-radius: 15px; font-size: 22px; font-weight: bold; cursor: pointer; transition: 0.3s; color: var(--dark); outline: none; }
        
        /* Á≠îÊ°àÂèçÈ•ãÈ°èËâ≤ */
        .opt-btn.btn-correct { background-color: #c6f6d5 !important; border-color: var(--success) !important; color: #22543d !important; }
        .opt-btn.btn-wrong { background-color: #fed7d7 !important; border-color: var(--error) !important; color: #822727 !important; }
        .opt-btn.used { pointer-events: none; opacity: 0.6; }
        .opt-btn.used.btn-correct, .opt-btn.used.btn-wrong { opacity: 1; }

        /* ÊãºÂ≠óÂçÄÊ®£Âºè */
        .word-slots { display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; margin: 30px 0; min-height: 60px; }
        .slot { width: 40px; height: 55px; border-bottom: 3px solid #cbd5e0; font-size: 32px; font-weight: bold; color: var(--primary); display: flex; align-items: center; justify-content: center; cursor: default; }
        .slot.active-hole { border-bottom-color: var(--primary); cursor: pointer; }
        .slot.fixed { border-bottom: none; color: #a0aec0; }

        .letter-bank { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 25px; padding: 20px; background: #f8fafc; border-radius: 18px; border: 1px dashed #cbd5e0; }
        .letter-card { width: 50px; height: 60px; background: white; border: 2px solid #e2e8f0; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; cursor: pointer; user-select: none; }
        .letter-card.used { opacity: 0.1; pointer-events: none; }

        .msg { margin-top: 20px; font-weight: bold; font-size: 22px; min-height: 33px; }
        .next-btn { width: 100%; padding: 20px; background: var(--primary); color: white; border: none; border-radius: 15px; font-size: 20px; cursor: pointer; display: none; margin-top: 20px; font-weight: bold; }
        
        .reset-link { margin-top: 40px; font-size: 13px; color: #a0aec0; cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>

<div class="card" id="game-card">
    <div class="header-info">
        <div class="stats-row">
            <div class="stat-box">Ê≠£Á¢∫Áéá: <span class="stat-val" id="stat-acc">0%</span> (<span id="stat-c">0</span>/<span id="stat-t">0</span>)</div>
            <div class="stat-box">Ë®àÊôÇ: <span class="stat-val" id="timer">00:00</span></div>
        </div>
        <div class="prog-bar-bg"><div id="prog-fill"></div></div>
    </div>

    <span class="stage-tag" id="stage-name">ËºâÂÖ•‰∏≠...</span>
    <div class="hint-cn" id="display-cn">---</div>

    <div id="ui-choice" style="display:none;">
        <div class="options-grid" id="choice-box"></div>
    </div>

    <div id="ui-spell" style="display:none;">
        <div class="word-slots" id="slots-box"></div>
        <div class="letter-bank" id="bank-box"></div>
    </div>

    <div class="msg" id="msg"></div>
    <button class="next-btn" id="next-btn" onclick="goNext()">‰∏ã‰∏ÄÈ°å (Á©∫ÁôΩÈçµ ‚éµ)</button>

    <div class="reset-link" onclick="resetAll()">Ê∏ÖÈô§ÈÄ≤Â∫¶ÈáçÊñ∞ÈñãÂßã</div>
</div>

<script>
    const WORDS = [
        { en: 'Tuesday', cn: 'ÊòüÊúü‰∫å' },
        { en: 'Wednesday', cn: 'ÊòüÊúü‰∏â' },
        { en: 'Thursday', cn: 'ÊòüÊúüÂõõ' }
    ];

    const STAGES = [
        { name: '1. Ëæ®Ë≠òÈÅ∏Êìá', mode: 'choice', holes: 0 },
        { name: '2. Áº∫Â≠óÂ°´Á©∫ (2)', mode: 'spell', holes: 2 },
        { name: '3. Áº∫Â≠óÂ°´Á©∫ (4)', mode: 'spell', holes: 4 },
        { name: '4. ÂÖ®ÊãºÊåëÊà∞', mode: 'spell', holes: 99 }
    ];

    let state = JSON.parse(localStorage.getItem('vocab_v8_color')) || { 
        s: 0, w: 0, correct: 0, total: 0, seconds: 0 
    };

    let timerInterval;
    let slotToCardMap = {}; 

    function save() { localStorage.setItem('vocab_v8_color', JSON.stringify(state)); }

    function startTimer() {
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if (state.s < STAGES.length) {
                state.seconds++;
                updateTimerUI();
            }
        }, 1000);
    }

    function updateTimerUI() {
        const m = Math.floor(state.seconds / 60).toString().padStart(2, '0');
        const s = (state.seconds % 60).toString().padStart(2, '0');
        document.getElementById('timer').innerText = `${m}:${s}`;
    }

    function render() {
        if (state.s >= STAGES.length) return showFinal();

        const stage = STAGES[state.s];
        const word = WORDS[state.w];
        const totalTasks = STAGES.length * WORDS.length;
        const currentTask = state.s * WORDS.length + state.w;
        const progressPercent = Math.floor((currentTask / totalTasks) * 100);

        updateTimerUI();
        document.getElementById('stat-c').innerText = state.correct;
        document.getElementById('stat-t').innerText = state.total;
        document.getElementById('stat-acc').innerText = (state.total === 0 ? 0 : Math.floor(state.correct/state.total*100)) + "%";
        document.getElementById('stage-name').innerText = stage.name;
        document.getElementById('display-cn').innerText = word.cn;
        document.getElementById('prog-fill').style.width = progressPercent + "%";
        document.getElementById('msg').innerText = "";
        document.getElementById('next-btn').style.display = "none";

        if (stage.mode === 'choice') {
            document.getElementById('ui-choice').style.display = "block";
            document.getElementById('ui-spell').style.display = "none";
            initChoice(word.en);
        } else {
            document.getElementById('ui-choice').style.display = "none";
            document.getElementById('ui-spell').style.display = "block";
            initSpell(word.en, stage.holes);
        }
    }

    function initChoice(correctEn) {
        const box = document.getElementById('choice-box');
        box.innerHTML = "";
        let opts = [correctEn];
        while(opts.length < 3) {
            let r = WORDS[Math.floor(Math.random()*WORDS.length)].en;
            if(!opts.includes(r)) opts.push(r);
        }
        opts.sort(() => Math.random() - 0.5).forEach(t => {
            const b = document.createElement('button');
            b.className = 'opt-btn';
            b.innerText = t;
            // ÈªûÊìäÊôÇÂÇ≥ÂÖ•Ëá™Â∑±ÁöÑÊñáÂ≠ó„ÄÅÊ≠£Á¢∫Á≠îÊ°à‰ª•ÂèäËá™Â∑±ÁöÑ Element
            b.onclick = () => handleChoiceSelect(t, correctEn, b);
            box.appendChild(b);
        });
    }

    // ËôïÁêÜÈÅ∏ÊìáÈ°åÈªûÊìä
    function handleChoiceSelect(selected, correct, element) {
        const isOk = (selected === correct);
        
        // Ê®ôË®òÊâÄÊúâÊåâÈàïÁÇ∫‰∏çÂèØÈªûÊìä
        const allBtns = document.querySelectorAll('.opt-btn');
        allBtns.forEach(btn => {
            btn.classList.add('used');
            // Â¶ÇÊûúÈÄôÂÄãÊåâÈàïÊòØÊ≠£Á¢∫Á≠îÊ°àÔºåÊ®ôË®òÁ∂†Ëâ≤
            if (btn.innerText === correct) {
                btn.classList.add('btn-correct');
            }
        });

        // Â¶ÇÊûúÈÅ∏ÈåØ‰∫ÜÔºåÂ∞áÈÅ∏‰∏≠ÁöÑÈÇ£ÂÄãÊ®ôË®òÁÇ∫Á¥ÖËâ≤
        if (!isOk) {
            element.classList.add('btn-wrong');
        }

        finishStep(isOk, correct);
    }

    function initSpell(en, holes) {
        const slotsBox = document.getElementById('slots-box');
        const bankBox = document.getElementById('bank-box');
        slotsBox.innerHTML = ""; bankBox.innerHTML = "";
        slotToCardMap = {};

        let indices = Array.from({length: en.length}, (_, i) => i);
        let targetHoles = (holes < en.length) 
            ? indices.sort(() => Math.random() - 0.5).slice(0, holes).sort((a,b) => a-b)
            : indices;

        targetHoles.forEach(idx => slotToCardMap[idx] = null);

        for(let i=0; i<en.length; i++) {
            const s = document.createElement('div');
            if (targetHoles.includes(i)) {
                s.className = 'slot active-hole';
                s.id = `slot-${i}`;
                s.innerText = "";
                s.onclick = () => undoSlot(i);
            } else {
                s.className = 'slot fixed';
                s.innerText = en[i];
            }
            slotsBox.appendChild(s);
        }

        let letters = targetHoles.map(idx => ({ char: en[idx], id: idx }));
        const alpha = "abcdefghijklmnopqrstuvwxyz";
        while(letters.length < targetHoles.length + 2) {
            letters.push({ char: alpha[Math.floor(Math.random()*26)], id: 'noise-' + Math.random() });
        }
        letters.sort(() => Math.random() - 0.5);

        letters.forEach((item, index) => {
            const c = document.createElement('div');
            c.className = 'letter-card';
            c.id = `card-${index}`;
            c.innerText = item.char;
            c.onclick = () => fillSlot(item.char, index, en);
            bankBox.appendChild(c);
        });
    }

    function fillSlot(char, cardIdx, correctEn) {
        const emptySlotId = Object.keys(slotToCardMap).find(id => slotToCardMap[id] === null);
        if (emptySlotId === undefined) return;

        const slot = document.getElementById(`slot-${emptySlotId}`);
        const card = document.getElementById(`card-${cardIdx}`);
        
        slot.innerText = char;
        card.classList.add('used');
        slotToCardMap[emptySlotId] = cardIdx;

        if (Object.values(slotToCardMap).every(v => v !== null)) {
            checkSpell(correctEn);
        }
    }

    function undoSlot(slotIdx) {
        const cardIdx = slotToCardMap[slotIdx];
        if (cardIdx === null || document.getElementById('next-btn').style.display === 'block') return;
        document.getElementById(`card-${cardIdx}`).classList.remove('used');
        document.getElementById(`slot-${slotIdx}`).innerText = "";
        slotToCardMap[slotIdx] = null;
        document.getElementById('msg').innerText = "";
    }

    function checkSpell(en) {
        let studentWord = "";
        const slots = document.getElementById('slots-box').children;
        for (let s of slots) studentWord += s.innerText;
        finishStep(studentWord === en, en);
    }

    function finishStep(isOk, correct) {
        state.total++;
        if (isOk) state.correct++;
        const msg = document.getElementById('msg');
        msg.innerText = isOk ? "‚úÖ Excellent!" : "‚ùå Try again! Correct: " + correct;
        msg.style.color = isOk ? "var(--success)" : "var(--error)";
        document.getElementById('next-btn').style.display = "block";
        
        document.querySelectorAll('.letter-card, .opt-btn, .slot').forEach(el => {
            el.style.pointerEvents = "none";
        });
        save();
    }

    function goNext() {
        state.w++;
        if (state.w >= WORDS.length) { state.w = 0; state.s++; }
        save(); render();
    }

    window.addEventListener('keydown', (e) => {
        if (e.code === 'Space' && document.getElementById('next-btn').style.display === 'block') {
            e.preventDefault(); goNext();
        }
    });

    function showFinal() {
        clearInterval(timerInterval);
        const finalTime = document.getElementById('timer').innerText;
        document.getElementById('game-card').innerHTML = `
            <h1 style="font-size:60px; margin:0;">üèÅ</h1>
            <h2>Á∑¥ÁøíÂÆåÊàêÔºÅ</h2>
            <p>Á∏ΩËä±Ë≤ªÊôÇÈñìÔºö<span class="stat-val">${finalTime}</span></p>
            <p>Ê≠£Á¢∫ÁéáÔºö<span class="stat-val">${Math.floor(state.correct/state.total*100)}%</span></p>
            <button class="next-btn" style="display:block" onclick="resetAll()">ÈáçÊñ∞ÊåëÊà∞</button>
        `;
    }

    function resetAll() { 
        if(confirm("Á¢∫ÂÆöË¶ÅÈáç‰æÜÂóéÔºü")) {
            localStorage.removeItem('vocab_v8_color'); 
            location.reload(); 
        }
    }

    startTimer();
    render();
</script>
</body>
</html>
