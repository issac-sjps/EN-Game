<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ–‡å–®å­—å¤§å­—å¡æŒ‘æˆ°</title>
    <style>
        :root { --primary: #4a90e2; --success: #48bb78; --error: #f56565; --bg: #f0f4f8; }
        body { font-family: 'PingFang TC', sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; margin: 0; }
        .card { background: white; width: 100%; max-width: 500px; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }
        
        /* é€²åº¦æ¢ */
        .prog-area { margin-bottom: 25px; }
        .prog-bar-bg { background: #e2e8f0; height: 14px; border-radius: 7px; overflow: hidden; margin-top: 5px; }
        #prog-fill { background: var(--success); width: 0%; height: 100%; transition: width 0.4s; }
        .prog-text { display: flex; justify-content: space-between; font-size: 14px; color: #718096; font-weight: bold; }

        .stage-tag { background: #ebf8ff; color: var(--primary); padding: 6px 18px; border-radius: 20px; font-size: 16px; font-weight: bold; }
        .hint-cn { font-size: 36px; font-weight: bold; margin: 25px 0; color: #2d3748; }

        /* å–®å­—æ§½ä½ï¼ˆä¸Šæ–¹å¡«ç©ºè™•ï¼‰ */
        .word-slots { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin: 30px 0; min-height: 60px; }
        .slot { width: 45px; height: 55px; border-bottom: 4px solid #cbd5e0; font-size: 32px; font-weight: bold; color: var(--primary); display: flex; align-items: center; justify-content: center; }
        .slot.fixed { border-bottom: none; color: #a0aec0; }

        /* å­—å¡å€ï¼ˆé»æ“Šé¸å–®ï¼‰ */
        .letter-bank { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); /* å›ºå®šå››åˆ—ï¼Œè‡ªç„¶å½¢æˆå¤šè¡Œ */
            gap: 15px; 
            margin-top: 25px; 
            padding: 20px; 
            background: #f8fafc; 
            border-radius: 15px; 
            justify-items: center;
        }
        .letter-card { 
            width: 60px; 
            height: 70px; 
            background: white; 
            border: 2px solid #e2e8f0; 
            border-radius: 12px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 28px; 
            font-weight: bold; 
            cursor: pointer; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
            transition: all 0.2s; 
        }
        .letter-card:hover { transform: translateY(-3px); border-color: var(--primary); color: var(--primary); box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
        .letter-card:active { transform: scale(0.9); }
        .letter-card.used { opacity: 0.2; cursor: default; pointer-events: none; }

        /* é¸æ“‡é¡Œå¤§æŒ‰éˆ• */
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin: 25px 0; }
        .opt-btn { padding: 20px; border: 2px solid #e2e8f0; background: white; border-radius: 12px; font-size: 22px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .opt-btn:hover { border-color: var(--primary); background: #f0f7ff; color: var(--primary); }

        .msg { margin-top: 20px; font-weight: bold; font-size: 22px; min-height: 30px; }
        .next-btn { width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 20px; cursor: pointer; display: none; margin-top: 20px; font-weight: bold; box-shadow: 0 4px 10px rgba(74, 144, 226, 0.3); }
        
        .reset-link { margin-top: 40px; font-size: 14px; color: #adb5bd; cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>

<div class="card" id="main-container">
    <div class="prog-area">
        <div class="prog-text">
            <span id="label-step">ç¬¬ 1 é¡Œ</span>
            <span id="label-percent">0%</span>
        </div>
        <div class="prog-bar-bg"><div id="prog-fill"></div></div>
    </div>

    <span class="stage-tag" id="stage-name">éšæ®µè¼‰å…¥ä¸­</span>
    <div class="hint-cn" id="display-cn">---</div>

    <div id="ui-choice" style="display:none;">
        <div class="options-grid" id="choice-box"></div>
    </div>

    <div id="ui-spell" style="display:none;">
        <div class="word-slots" id="slots-box"></div>
        <div class="letter-bank" id="bank-box"></div>
        <p style="margin-top:15px; color:#a0aec0; font-size:14px;">é»æ“Šä¸Šæ–¹å¤§å­—å¡å¡«å…¥ç©ºæ ¼</p>
    </div>

    <div class="msg" id="msg"></div>
    <button class="next-btn" id="next-btn" onclick="goNext()">ä¸‹ä¸€é¡Œ (Next Step)</button>

    <div class="reset-link" onclick="resetAll()">æ¸…é™¤é€²åº¦ä¸¦é‡æ–°é–‹å§‹</div>
</div>

<script>
    const WORDS = [
        { en: 'science', cn: 'ç§‘å­¸' },
        { en: 'subject', cn: 'ç§‘ç›®' },
        { en: 'favorite', cn: 'æœ€å–œæ„›çš„' }
    ];

    const STAGES = [
        { name: 'éšæ®µ 1ï¼šå–®å­—é¸æ“‡é¡Œ', mode: 'choice', holes: 0 },
        { name: 'éšæ®µ 2ï¼šæ‹¼å­—å¡«ç©º (ç¼º2å­—)', mode: 'spell', holes: 2 },
        { name: 'éšæ®µ 3ï¼šé€²éšå¡«ç©º (ç¼º3å­—)', mode: 'spell', holes: 3 },
        { name: 'éšæ®µ 4ï¼šçµ‚æ¥µæŒ‘æˆ° (å…¨æ‹¼)', mode: 'spell', holes: 99 }
    ];

    let state = JSON.parse(localStorage.getItem('vocab_v4_state')) || { s: 0, w: 0 };
    let currentAnswers = []; 
    let targetHoles = [];    

    function save() { localStorage.setItem('vocab_v4_state', JSON.stringify(state)); }

    function render() {
        if (state.s >= STAGES.length) return showFinal();

        const stage = STAGES[state.s];
        const word = WORDS[state.w];
        const total = STAGES.length * WORDS.length;
        const count = (state.s * WORDS.length) + state.w;
        const percent = Math.floor((count / total) * 100);

        document.getElementById('stage-name').innerText = stage.name;
        document.getElementById('display-cn').innerText = word.cn;
        document.getElementById('prog-fill').style.width = percent + "%";
        document.getElementById('label-percent').innerText = percent + "%";
        document.getElementById('label-step').innerText = `é€²åº¦ ${count + 1} / ${total}`;
        document.getElementById('msg').innerText = "";
        document.getElementById('next-btn').style.display = "none";

        if (stage.mode === 'choice') {
            document.getElementById('ui-choice').style.display = "block";
            document.getElementById('ui-spell').style.display = "none";
            initChoice(word.en);
        } else {
            document.getElementById('ui-choice').style.display = "none";
            document.getElementById('ui-spell').style.display = "block";
            initSpell(word.en, stage.holes);
        }
    }

    function initChoice(correct) {
        const box = document.getElementById('choice-box');
        box.innerHTML = "";
        let opts = [correct];
        while(opts.length < 3 && opts.length < WORDS.length) {
            let r = WORDS[Math.floor(Math.random()*WORDS.length)].en;
            if(!opts.includes(r)) opts.push(r);
        }
        opts.sort(() => Math.random() - 0.5).forEach(t => {
            const b = document.createElement('button');
            b.className = 'opt-btn';
            b.innerText = t;
            b.onclick = () => finishStep(t === correct, correct);
            box.appendChild(b);
        });
    }

    function initSpell(en, holes) {
        const slotsBox = document.getElementById('slots-box');
        const bankBox = document.getElementById('bank-box');
        slotsBox.innerHTML = "";
        bankBox.innerHTML = "";
        currentAnswers = [];
        targetHoles = [];

        // éš¨æ©Ÿé¸å–æŒ–ç©ºä½ç½®
        let indices = Array.from({length: en.length}, (_, i) => i);
        indices.sort(() => Math.random() - 0.5);
        targetHoles = indices.slice(0, Math.min(holes, en.length)).sort((a,b) => a-b);

        // å»ºç«‹ä¸Šæ–¹ç©ºæ ¼
        for(let i=0; i<en.length; i++) {
            const s = document.createElement('div');
            if (targetHoles.includes(i)) {
                s.className = 'slot';
                s.id = `slot-${i}`;
                s.innerText = "";
            } else {
                s.className = 'slot fixed';
                s.innerText = en[i];
            }
            slotsBox.appendChild(s);
        }

        // ä¸‹æ–¹å­—å¡ï¼šæ­£ç¢ºç­”æ¡ˆ + 2å€‹å¹²æ“¾å­—æ¯
        let cards = targetHoles.map(idx => en[idx]);
        const alphabet = "abcdefghijklmnopqrstuvwxyz";
        while(cards.length < targetHoles.length + 2) {
            let r = alphabet[Math.floor(Math.random()*26)];
            if(!cards.includes(r)) cards.push(r);
        }
        cards.sort(() => Math.random() - 0.5);

        // æ¸²æŸ“å­—å¡
        cards.forEach(char => {
            const c = document.createElement('div');
            c.className = 'letter-card';
            c.innerText = char;
            c.onclick = () => {
                if (currentAnswers.length < targetHoles.length) {
                    const targetIdx = targetHoles[currentAnswers.length];
                    document.getElementById(`slot-${targetIdx}`).innerText = char;
                    currentAnswers.push(char);
                    c.classList.add('used');
                    if (currentAnswers.length === targetHoles.length) checkSpell(en);
                }
            };
            bankBox.appendChild(c);
        });
    }

    function checkSpell(en) {
        let result = "";
        let holePtr = 0;
        for(let i=0; i<en.length; i++) {
            if(targetHoles.includes(i)) result += currentAnswers[holePtr++];
            else result += en[i];
        }
        finishStep(result === en, en);
    }

    function finishStep(isOk, correct) {
        const msg = document.getElementById('msg');
        msg.innerText = isOk ? "âœ… ç­”å°äº†ï¼å¤ªå¼·äº†" : "âŒ å“å‘€ç­”éŒ¯äº†ï¼Œæ­£ç¢ºæ˜¯: " + correct;
        msg.style.color = isOk ? "var(--success)" : "var(--error)";
        document.getElementById('next-btn').style.display = "block";
        document.querySelectorAll('.letter-card').forEach(c => c.classList.add('used'));
        document.querySelectorAll('.opt-btn').forEach(b => b.disabled = true);
    }

    function goNext() {
        state.w++;
        if (state.w >= WORDS.length) { state.w = 0; state.s++; }
        save();
        render();
    }

    function showFinal() {
        document.getElementById('main-container').innerHTML = `
            <h1 style="font-size:80px; margin:0;">ğŸŠ</h1>
            <h2 style="font-size:32px; color:var(--success);">æŒ‘æˆ°æˆåŠŸï¼</h2>
            <p style="font-size:18px; color:#718096;">ä½ å·²ç¶“ç²¾é€šé€™çµ„å–®å­—çš„æ‰€æœ‰æ¨¡å¼ã€‚</p>
            <button class="next-btn" style="display:block" onclick="resetAll()">é‡æ–°æŒ‘æˆ°</button>
        `;
    }

    function resetAll() { localStorage.removeItem('vocab_v4_state'); location.reload(); }

    render();
</script>

</body>
</html>
