<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å–®å­—æ¸¬é©— - è€å¸«é©—æ”¶ç‰ˆ</title>
    <style>
        :root { --primary: #4a90e2; --success: #48bb78; --error: #f56565; --bg: #f0f4f8; --dark: #2d3748; }
        body { font-family: 'PingFang TC', sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; margin: 0; }
        .card { background: white; width: 100%; max-width: 500px; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; position: relative; }
        
        /* çµ±è¨ˆèˆ‡è¨ˆæ™‚å€ */
        .header-info { margin-bottom: 20px; border-bottom: 2px solid #edf2f7; padding-bottom: 15px; }
        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; font-size: 14px; }
        .stat-box { background: #f8fafc; padding: 8px; border-radius: 10px; border: 1px solid #e2e8f0; color: var(--dark); }
        .stat-val { font-weight: bold; color: var(--primary); font-size: 16px; }

        .prog-bar-bg { background: #e2e8f0; height: 12px; border-radius: 6px; overflow: hidden; margin-top: 10px; }
        #prog-fill { background: var(--success); width: 0%; height: 100%; transition: width 0.4s; }

        .stage-tag { background: #ebf8ff; color: var(--primary); padding: 6px 18px; border-radius: 20px; font-size: 15px; font-weight: bold; display: inline-block; margin-bottom: 10px; }
        .hint-cn { font-size: 36px; font-weight: bold; margin: 15px 0; color: var(--dark); }

        /* å¤§å­—å¡èˆ‡æ§½ä½ */
        .word-slots { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin: 25px 0; min-height: 60px; }
        .slot { width: 45px; height: 55px; border-bottom: 4px solid #cbd5e0; font-size: 32px; font-weight: bold; color: var(--primary); display: flex; align-items: center; justify-content: center; }
        .slot.fixed { border-bottom: none; color: #a0aec0; }

        .letter-bank { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 20px; padding: 20px; background: #f8fafc; border-radius: 15px; }
        .letter-card { width: 60px; height: 70px; background: white; border: 2px solid #e2e8f0; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: bold; cursor: pointer; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .letter-card:hover { transform: translateY(-3px); border-color: var(--primary); }
        .letter-card.used { opacity: 0.1; pointer-events: none; }

        /* é¸æ“‡é¡Œ */
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin: 20px 0; }
        .opt-btn { padding: 18px; border: 2px solid #e2e8f0; background: white; border-radius: 12px; font-size: 20px; font-weight: bold; cursor: pointer; }

        .msg { margin-top: 15px; font-weight: bold; font-size: 20px; min-height: 28px; }
        .next-btn { width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 18px; cursor: pointer; display: none; margin-top: 15px; font-weight: bold; }
        
        /* é€šé—œç‰¹å¯« */
        .pass-banner { background: #c6f6d5; color: #22543d; padding: 20px; border-radius: 15px; border: 3px solid #48bb78; margin-top: 20px; font-size: 20px; font-weight: bold; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }

        .reset-link { margin-top: 40px; font-size: 13px; color: #adb5bd; cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>

<div class="card" id="game-card">
    <div class="header-info">
        <div class="stats-row">
            <div class="stat-box">æ­£ç¢ºç‡: <span class="stat-val" id="stat-acc">0%</span> (<span id="stat-c">0</span>/<span id="stat-t">0</span>)</div>
            <div class="stat-box">è¨ˆæ™‚: <span class="stat-val" id="timer">00:00</span></div>
        </div>
        <div class="prog-bar-bg"><div id="prog-fill"></div></div>
    </div>

    <span class="stage-tag" id="stage-name">éšæ®µè¼‰å…¥ä¸­</span>
    <div class="hint-cn" id="display-cn">---</div>

    <div id="ui-choice" style="display:none;">
        <div class="options-grid" id="choice-box"></div>
    </div>

    <div id="ui-spell" style="display:none;">
        <div class="word-slots" id="slots-box"></div>
        <div class="letter-bank" id="bank-box"></div>
    </div>

    <div class="msg" id="msg"></div>
    <button class="next-btn" id="next-btn" onclick="goNext()">ä¸‹ä¸€é¡Œ (ç©ºç™½éµ âµ)</button>

    <div class="reset-link" onclick="resetAll()">æ¸…é™¤é€²åº¦é‡æ–°é–‹å§‹ (æ­¸é›¶æ™‚é–“)</div>
</div>

<script>
    const WORDS = [
        { en: 'science', cn: 'ç§‘å­¸' },
        { en: 'subject', cn: 'ç§‘ç›®' },
        { en: 'favorite', cn: 'æœ€å–œæ„›çš„' }
    ];

    const STAGES = [
        { name: '1. å–®å­—é¸æ“‡', mode: 'choice', holes: 0 },
        { name: '2. å¡«ç©º (ç¼º2å­—)', mode: 'spell', holes: 2 },
        { name: '3. å¡«ç©º (ç¼º3å­—)', mode: 'spell', holes: 3 },
        { name: '4. å…¨æ‹¼æŒ‘æˆ°', mode: 'spell', holes: 99 }
    ];

    // ç‹€æ…‹åŒ…å«è¨ˆæ™‚ï¼ˆç§’æ•¸ï¼‰
    let state = JSON.parse(localStorage.getItem('vocab_v6_teacher')) || { 
        s: 0, w: 0, correct: 0, total: 0, seconds: 0 
    };

    let currentAnswers = []; 
    let targetHoles = [];    
    let timerInterval;

    function save() { localStorage.setItem('vocab_v6_teacher', JSON.stringify(state)); }

    function startTimer() {
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if (state.s < STAGES.length) {
                state.seconds++;
                updateTimerUI();
                if (state.seconds % 5 === 0) save(); // æ¯ 5 ç§’è‡ªå‹•å­˜ä¸€æ¬¡æ™‚é–“
            }
        }, 1000);
    }

    function updateTimerUI() {
        const m = Math.floor(state.seconds / 60).toString().padStart(2, '0');
        const s = (state.seconds % 60).toString().padStart(2, '0');
        document.getElementById('timer').innerText = `${m}:${s}`;
    }

    function render() {
        if (state.s >= STAGES.length) return showFinal();

        const stage = STAGES[state.s];
        const word = WORDS[state.w];
        const progressPercent = Math.floor(((state.s * WORDS.length + state.w) / (STAGES.length * WORDS.length)) * 100);

        updateTimerUI();
        document.getElementById('stat-c').innerText = state.correct;
        document.getElementById('stat-t').innerText = state.total;
        document.getElementById('stat-acc').innerText = (state.total === 0 ? 0 : Math.floor(state.correct/state.total*100)) + "%";
        document.getElementById('stage-name').innerText = stage.name;
        document.getElementById('display-cn').innerText = word.cn;
        document.getElementById('prog-fill').style.width = progressPercent + "%";
        document.getElementById('msg').innerText = "";
        document.getElementById('next-btn').style.display = "none";

        if (stage.mode === 'choice') {
            document.getElementById('ui-choice').style.display = "block";
            document.getElementById('ui-spell').style.display = "none";
            initChoice(word.en);
        } else {
            document.getElementById('ui-choice').style.display = "none";
            document.getElementById('ui-spell').style.display = "block";
            initSpell(word.en, stage.holes);
        }
    }

    function initChoice(correct) {
        const box = document.getElementById('choice-box');
        box.innerHTML = "";
        let opts = [correct];
        while(opts.length < 3 && opts.length < WORDS.length) {
            let r = WORDS[Math.floor(Math.random()*WORDS.length)].en;
            if(!opts.includes(r)) opts.push(r);
        }
        opts.sort(() => Math.random() - 0.5).forEach(t => {
            const b = document.createElement('button');
            b.className = 'opt-btn';
            b.innerText = t;
            b.onclick = () => finishStep(t === correct, correct);
            box.appendChild(b);
        });
    }

    function initSpell(en, holes) {
        const slotsBox = document.getElementById('slots-box');
        const bankBox = document.getElementById('bank-box');
        slotsBox.innerHTML = ""; bankBox.innerHTML = "";
        currentAnswers = []; targetHoles = [];

        let indices = Array.from({length: en.length}, (_, i) => i);
        indices.sort(() => Math.random() - 0.5);
        targetHoles = indices.slice(0, Math.min(holes, en.length)).sort((a,b) => a-b);

        for(let i=0; i<en.length; i++) {
            const s = document.createElement('div');
            if (targetHoles.includes(i)) {
                s.className = 'slot'; s.id = `slot-${i}`; s.innerText = "";
            } else {
                s.className = 'slot fixed'; s.innerText = en[i];
            }
            slotsBox.appendChild(s);
        }

        let cards = targetHoles.map(idx => en[idx]);
        const alpha = "abcdefghijklmnopqrstuvwxyz";
        while(cards.length < targetHoles.length + 2) {
            let r = alpha[Math.floor(Math.random()*26)];
            if(!cards.includes(r)) cards.push(r);
        }
        cards.sort(() => Math.random() - 0.5);

        cards.forEach(char => {
            const c = document.createElement('div');
            c.className = 'letter-card';
            c.innerText = char;
            c.onclick = () => {
                if (currentAnswers.length < targetHoles.length) {
                    const targetIdx = targetHoles[currentAnswers.length];
                    document.getElementById(`slot-${targetIdx}`).innerText = char;
                    currentAnswers.push(char);
                    c.classList.add('used');
                    if (currentAnswers.length === targetHoles.length) checkSpell(en);
                }
            };
            bankBox.appendChild(c);
        });
    }

    function checkSpell(en) {
        let res = ""; let hP = 0;
        for(let i=0; i<en.length; i++) res += targetHoles.includes(i) ? currentAnswers[hP++] : en[i];
        finishStep(res === en, en);
    }

    function finishStep(isOk, correct) {
        state.total++;
        if (isOk) state.correct++;
        const msg = document.getElementById('msg');
        msg.innerText = isOk ? "âœ… ç­”å°äº†ï¼" : "âŒ ç­”éŒ¯äº†ï¼Œæ­£ç¢ºæ˜¯: " + correct;
        msg.style.color = isOk ? "var(--success)" : "var(--error)";
        document.getElementById('next-btn').style.display = "block";
        document.querySelectorAll('.letter-card, .opt-btn').forEach(el => { el.classList.add('used'); el.disabled = true; });
        save();
    }

    function goNext() {
        state.w++;
        if (state.w >= WORDS.length) { state.w = 0; state.s++; }
        save(); render();
    }

    window.addEventListener('keydown', (e) => {
        if (e.code === 'Space' && document.getElementById('next-btn').style.display === 'block') {
            e.preventDefault(); goNext();
        }
    });

    function showFinal() {
        clearInterval(timerInterval);
        const finalTime = document.getElementById('timer').innerText;
        const isUnder10 = state.seconds < 600;
        
        document.getElementById('game-card').innerHTML = `
            <h1 style="font-size:60px; margin:0;">ğŸ</h1>
            <h2>ç·´ç¿’å®Œæˆï¼</h2>
            <p>ç¸½èŠ±è²»æ™‚é–“ï¼š<span class="stat-val">${finalTime}</span></p>
            <p>æ­£ç¢ºç‡ï¼š<span class="stat-val">${Math.floor(state.correct/state.total*100)}%</span></p>
            
            ${isUnder10 ? `
                <div class="pass-banner">
                    ğŸŒŸ é”æˆè€å¸«è¦æ±‚é€šé—œæ¨™æº– ğŸŒŸ<br>
                    ä¸è¦é—œæ‰ï¼Œè«‹èˆ‰æ‰‹çµ¦è€å¸«é©—æ”¶<br>
                    ã€ é é—œ ã€‘
                </div>
            ` : `<p style="color:var(--error)">è¶…é 10 åˆ†é˜ï¼Œè«‹å†æ¥å†å²ï¼</p>`}

            <button class="next-btn" style="display:block" onclick="resetAll()">é‡æ–°æŒ‘æˆ° (é‡è¨ˆæ™‚é–“)</button>
        `;
    }

    function resetAll() { localStorage.removeItem('vocab_v6_teacher'); location.reload(); }

    startTimer();
    render();
</script>
</body>
</html>
