<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ–‡å–®å­—æŒ‘æˆ° - çµ±è¨ˆç‰ˆ</title>
    <style>
        :root { --primary: #4a90e2; --success: #48bb78; --error: #f56565; --bg: #f0f4f8; }
        body { font-family: 'PingFang TC', sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; margin: 0; }
        .card { background: white; width: 100%; max-width: 500px; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; position: relative; }
        
        /* çµ±è¨ˆèˆ‡é€²åº¦å€ */
        .header-info { margin-bottom: 25px; border-bottom: 1px dashed #e2e8f0; padding-bottom: 15px; }
        .stats-row { display: flex; justify-content: space-around; margin-bottom: 10px; font-size: 14px; color: #4a5568; }
        .stat-box { background: #f8fafc; padding: 5px 10px; border-radius: 8px; border: 1px solid #edf2f7; }
        .stat-val { font-weight: bold; color: var(--primary); }

        .prog-bar-bg { background: #e2e8f0; height: 12px; border-radius: 6px; overflow: hidden; margin-top: 10px; }
        #prog-fill { background: var(--success); width: 0%; height: 100%; transition: width 0.4s; }

        .stage-tag { background: #ebf8ff; color: var(--primary); padding: 6px 18px; border-radius: 20px; font-size: 15px; font-weight: bold; }
        .hint-cn { font-size: 36px; font-weight: bold; margin: 20px 0; color: #2d3748; }

        /* å–®å­—æ§½ä½ */
        .word-slots { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin: 25px 0; min-height: 60px; }
        .slot { width: 45px; height: 55px; border-bottom: 4px solid #cbd5e0; font-size: 32px; font-weight: bold; color: var(--primary); display: flex; align-items: center; justify-content: center; }
        .slot.fixed { border-bottom: none; color: #a0aec0; }

        /* å¤§å­—å¡å€ */
        .letter-bank { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 15px; 
            margin-top: 20px; 
            padding: 20px; 
            background: #f8fafc; 
            border-radius: 15px; 
        }
        .letter-card { 
            width: 60px; height: 70px; background: white; border: 2px solid #e2e8f0; 
            border-radius: 12px; display: flex; align-items: center; justify-content: center; 
            font-size: 28px; font-weight: bold; cursor: pointer; transition: all 0.2s; 
        }
        .letter-card:hover { transform: translateY(-3px); border-color: var(--primary); color: var(--primary); }
        .letter-card.used { opacity: 0.15; cursor: default; pointer-events: none; }

        /* é¸æ“‡é¡Œ */
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin: 20px 0; }
        .opt-btn { padding: 18px; border: 2px solid #e2e8f0; background: white; border-radius: 12px; font-size: 20px; font-weight: bold; cursor: pointer; }
        .opt-btn:hover { border-color: var(--primary); background: #f0f7ff; }

        .msg { margin-top: 15px; font-weight: bold; font-size: 22px; min-height: 30px; }
        .next-btn { width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 18px; cursor: pointer; display: none; margin-top: 15px; font-weight: bold; }
        .k-hint { font-size: 12px; color: #adb5bd; margin-top: 8px; font-weight: normal; }

        .reset-link { margin-top: 40px; font-size: 13px; color: #adb5bd; cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>

<div class="card">
    <div class="header-info">
        <div class="stats-row">
            <div class="stat-box">æ­£ç¢º: <span class="stat-val" id="stat-correct">0</span></div>
            <div class="stat-box">ç¸½è¨ˆ: <span class="stat-val" id="stat-total">0</span></div>
            <div class="stat-box">æ­£ç¢ºç‡: <span class="stat-val" id="stat-acc">0%</span></div>
        </div>
        <div class="prog-bar-bg"><div id="prog-fill"></div></div>
    </div>

    <span class="stage-tag" id="stage-name">è¼‰å…¥ä¸­...</span>
    <div class="hint-cn" id="display-cn">---</div>

    <div id="ui-choice" style="display:none;">
        <div class="options-grid" id="choice-box"></div>
    </div>

    <div id="ui-spell" style="display:none;">
        <div class="word-slots" id="slots-box"></div>
        <div class="letter-bank" id="bank-box"></div>
    </div>

    <div class="msg" id="msg"></div>
    <button class="next-btn" id="next-btn" onclick="goNext()">
        ä¸‹ä¸€é¡Œ (Next Step)
        <div class="k-hint">æŒ‰ [ç©ºç™½éµ] ä¹Ÿå¯ä»¥ç¹¼çºŒ</div>
    </button>

    <div class="reset-link" onclick="resetAll()">æ¸…é™¤é€²åº¦èˆ‡çµ±è¨ˆï¼Œé‡é ­é–‹å§‹</div>
</div>

<script>
    const WORDS = [
        { en: 'science', cn: 'ç§‘å­¸' },
        { en: 'subject', cn: 'ç§‘ç›®' },
        { en: 'favorite', cn: 'æœ€å–œæ„›çš„' }
    ];

    const STAGES = [
        { name: '1. å–®å­—é¸æ“‡é¡Œ', mode: 'choice', holes: 0 },
        { name: '2. å¡«ç©º (ç¼º2å­—)', mode: 'spell', holes: 2 },
        { name: '3. å¡«ç©º (ç¼º3å­—)', mode: 'spell', holes: 3 },
        { name: '4. çµ‚æ¥µæŒ‘æˆ° (å…¨æ‹¼)', mode: 'spell', holes: 99 }
    ];

    // åˆå§‹åŒ–ç‹€æ…‹ï¼Œå¢åŠ æ­£ç¢ºæ•¸èˆ‡ç¸½é¡Œæ•¸
    let state = JSON.parse(localStorage.getItem('vocab_v5_save')) || { 
        s: 0, w: 0, correct: 0, total: 0 
    };

    let currentAnswers = []; 
    let targetHoles = [];    

    function save() { localStorage.setItem('vocab_v5_save', JSON.stringify(state)); }

    function updateStatsUI() {
        document.getElementById('stat-correct').innerText = state.correct;
        document.getElementById('stat-total').innerText = state.total;
        const acc = state.total === 0 ? 0 : Math.floor((state.correct / state.total) * 100);
        document.getElementById('stat-acc').innerText = acc + "%";
    }

    function render() {
        if (state.s >= STAGES.length) return showFinal();

        const stage = STAGES[state.s];
        const word = WORDS[state.w];
        const allSteps = STAGES.length * WORDS.length;
        const finishedSteps = (state.s * WORDS.length) + state.w;
        const progressPercent = Math.floor((finishedSteps / allSteps) * 100);

        updateStatsUI();
        document.getElementById('stage-name').innerText = stage.name;
        document.getElementById('display-cn').innerText = word.cn;
        document.getElementById('prog-fill').style.width = progressPercent + "%";
        document.getElementById('msg').innerText = "";
        document.getElementById('next-btn').style.display = "none";

        if (stage.mode === 'choice') {
            document.getElementById('ui-choice').style.display = "block";
            document.getElementById('ui-spell').style.display = "none";
            initChoice(word.en);
        } else {
            document.getElementById('ui-choice').style.display = "none";
            document.getElementById('ui-spell').style.display = "block";
            initSpell(word.en, stage.holes);
        }
    }

    function initChoice(correct) {
        const box = document.getElementById('choice-box');
        box.innerHTML = "";
        let opts = [correct];
        while(opts.length < 3 && opts.length < WORDS.length) {
            let r = WORDS[Math.floor(Math.random()*WORDS.length)].en;
            if(!opts.includes(r)) opts.push(r);
        }
        opts.sort(() => Math.random() - 0.5).forEach(t => {
            const b = document.createElement('button');
            b.className = 'opt-btn';
            b.innerText = t;
            b.onclick = () => finishStep(t === correct, correct);
            box.appendChild(b);
        });
    }

    function initSpell(en, holes) {
        const slotsBox = document.getElementById('slots-box');
        const bankBox = document.getElementById('bank-box');
        slotsBox.innerHTML = ""; bankBox.innerHTML = "";
        currentAnswers = []; targetHoles = [];

        let indices = Array.from({length: en.length}, (_, i) => i);
        indices.sort(() => Math.random() - 0.5);
        targetHoles = indices.slice(0, Math.min(holes, en.length)).sort((a,b) => a-b);

        for(let i=0; i<en.length; i++) {
            const s = document.createElement('div');
            if (targetHoles.includes(i)) {
                s.className = 'slot'; s.id = `slot-${i}`; s.innerText = "";
            } else {
                s.className = 'slot fixed'; s.innerText = en[i];
            }
            slotsBox.appendChild(s);
        }

        let cards = targetHoles.map(idx => en[idx]);
        const alpha = "abcdefghijklmnopqrstuvwxyz";
        while(cards.length < targetHoles.length + 2) {
            let r = alpha[Math.floor(Math.random()*26)];
            if(!cards.includes(r)) cards.push(r);
        }
        cards.sort(() => Math.random() - 0.5);

        cards.forEach(char => {
            const c = document.createElement('div');
            c.className = 'letter-card';
            c.innerText = char;
            c.onclick = () => {
                if (currentAnswers.length < targetHoles.length) {
                    const targetIdx = targetHoles[currentAnswers.length];
                    document.getElementById(`slot-${targetIdx}`).innerText = char;
                    currentAnswers.push(char);
                    c.classList.add('used');
                    if (currentAnswers.length === targetHoles.length) checkSpell(en);
                }
            };
            bankBox.appendChild(c);
        });
    }

    function checkSpell(en) {
        let result = ""; let holePtr = 0;
        for(let i=0; i<en.length; i++) {
            if(targetHoles.includes(i)) result += currentAnswers[holePtr++];
            else result += en[i];
        }
        finishStep(result === en, en);
    }

    function finishStep(isOk, correct) {
        state.total++;
        if (isOk) state.correct++;
        updateStatsUI();

        const msg = document.getElementById('msg');
        msg.innerText = isOk ? "âœ… ç­”å°äº†ï¼" : "âŒ ç­”éŒ¯äº†ï¼Œæ­£ç¢ºæ˜¯: " + correct;
        msg.style.color = isOk ? "var(--success)" : "var(--error)";
        document.getElementById('next-btn').style.display = "block";
        
        document.querySelectorAll('.letter-card').forEach(c => c.classList.add('used'));
        document.querySelectorAll('.opt-btn').forEach(b => b.disabled = true);
        save();
    }

    function goNext() {
        state.w++;
        if (state.w >= WORDS.length) { state.w = 0; state.s++; }
        save(); render();
    }

    // ç©ºç™½éµç›£è½
    window.addEventListener('keydown', (e) => {
        if (e.code === 'Space') {
            const btn = document.getElementById('next-btn');
            if (btn.style.display === 'block') {
                e.preventDefault(); // é¿å…ç¶²é æ»¾å‹•
                goNext();
            }
        }
    });

    function showFinal() {
        document.getElementById('prog-fill').style.width = "100%";
        updateStatsUI();
        document.querySelector('.card').innerHTML = `
            <h1 style="font-size:80px; margin:0;">ğŸ†</h1>
            <h2>ç·´ç¿’çµæŸï¼</h2>
            <div class="stats-row" style="margin: 20px 0;">
                <div class="stat-box">æœ€çµ‚æ­£ç¢ºç‡: <span class="stat-val">${document.getElementById('stat-acc').innerText}</span></div>
            </div>
            <p>ä½ å·²ç¶“å®Œæˆé€™çµ„å–®å­—çš„æ‰€æœ‰æŒ‘æˆ°ã€‚</p>
            <button class="next-btn" style="display:block" onclick="resetAll()">é‡æ–°æŒ‘æˆ°</button>
        `;
    }

    function resetAll() { localStorage.removeItem('vocab_v5_save'); location.reload(); }

    render();
</script>

</body>
</html>
