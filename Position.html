<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Preposition Learning System</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 20px;
      font-family: 'Comic Sans MS', 'Arial', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .container {
      max-width: 1000px;
      width: 100%;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    h1 {
      text-align: center;
      color: #667eea;
      margin: 0 0 10px 0;
      font-size: 36px;
    }

    .subtitle {
      text-align: center;
      color: #666;
      font-size: 18px;
      margin-bottom: 30px;
    }

    .nav-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 30px 0;
      flex-wrap: wrap;
    }

    .nav-button {
      padding: 15px 30px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      min-width: 150px;
    }

    .nav-button.primary {
      background: #667eea;
      color: white;
    }

    .nav-button.primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
    }

    .nav-button.secondary {
      background: #28a745;
      color: white;
    }

    .nav-button.secondary:hover {
      background: #218838;
      transform: translateY(-2px);
    }

    .nav-button.danger {
      background: #dc3545;
      color: white;
    }

    .nav-button.danger:hover {
      background: #c82333;
      transform: translateY(-2px);
    }

    .section {
      margin: 30px 0;
      padding: 25px;
      background: #f8f9fa;
      border-radius: 15px;
      border-left: 5px solid #667eea;
    }

    .section h2 {
      color: #667eea;
      margin: 0 0 20px 0;
      font-size: 24px;
    }

    .question-bank {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .preposition-group {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .preposition-title {
      font-size: 20px;
      font-weight: bold;
      color: #dc3545;
      margin-bottom: 15px;
      text-align: center;
    }

    .example-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .example-list li {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .example-list li:last-child {
      border-bottom: none;
    }

    .emoji {
      font-size: 24px;
    }

    .chinese {
      color: #666;
      font-size: 14px;
      margin-left: auto;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .stat-number {
      font-size: 36px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 10px;
    }

    .stat-label {
      color: #666;
      font-size: 14px;
    }

    .records-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .records-table th,
    .records-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    .records-table th {
      background: #667eea;
      color: white;
      font-weight: bold;
    }

    .records-table tr:hover {
      background: #f8f9fa;
    }

    .correct {
      color: #28a745;
      font-weight: bold;
    }

    .incorrect {
      color: #dc3545;
      font-weight: bold;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .no-records {
      text-align: center;
      padding: 40px;
      color: #666;
      font-style: italic;
    }

    /* Game Styles */
    .score-board {
      display: flex;
      justify-content: space-around;
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
    }

    .score-item {
      text-align: center;
    }

    .score-label {
      font-size: 14px;
      color: #666;
      margin-bottom: 5px;
    }

    .score-value {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
    }

    .question-area {
      margin: 30px 0;
      padding: 20px;
      background: #fff9e6;
      border-radius: 10px;
      border: 3px solid #ffd700;
    }

    .question-text {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      color: #333;
      margin-bottom: 20px;
    }

    .game-area {
      position: relative;
      width: 100%;
      height: 400px;
      background: #e8f4f8;
      border-radius: 15px;
      margin: 20px 0;
      overflow: hidden;
    }

    .table {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 300px;
      height: 150px;
      background: #8b4513;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .table::after {
      content: '';
      position: absolute;
      bottom: -80px;
      left: 20px;
      width: 20px;
      height: 80px;
      background: #654321;
      border-radius: 5px;
    }

    .table::before {
      content: '';
      position: absolute;
      bottom: -80px;
      right: 20px;
      width: 20px;
      height: 80px;
      background: #654321;
      border-radius: 5px;
    }

    .drawer {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 280px;
      height: 80px;
      background: #654321;
      border-radius: 8px;
      margin-top: 75px;
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.3);
      border: 2px solid #4a2c17;
    }

    .drawer::after {
      content: '';
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 15px;
      height: 15px;
      background: #333;
      border-radius: 50%;
      box-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }

    .draggable-object {
      position: absolute;
      width: 60px;
      height: 60px;
      background: #ff6b6b;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      cursor: move;
      user-select: none;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: transform 0.2s;
      z-index: 10;
    }

    .draggable-object:hover {
      transform: scale(1.1);
    }

    .draggable-object.dragging {
      opacity: 0.7;
      transform: scale(1.15);
    }

    .feedback {
      text-align: center;
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
      font-size: 18px;
      font-weight: bold;
      min-height: 50px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .feedback.correct {
      background: #d4edda;
      color: #155724;
      border: 2px solid #28a745;
    }

    .feedback.incorrect {
      background: #f8d7da;
      color: #721c24;
      border: 2px solid #dc3545;
    }

    .feedback.hidden {
      visibility: hidden;
    }

    .chinese-answer {
      font-size: 16px;
      margin-top: 8px;
      color: #666;
    }

    .next-button {
      display: block;
      margin: 20px auto;
      padding: 15px 40px;
      font-size: 18px;
      font-weight: bold;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .next-button:hover {
      background: #5568d3;
    }

    .next-button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .completion-screen {
      text-align: center;
      padding: 40px;
    }

    .completion-screen h2 {
      color: #667eea;
      font-size: 36px;
      margin-bottom: 20px;
    }

    .final-score {
      font-size: 48px;
      color: #28a745;
      margin: 20px 0;
    }

    .restart-button {
      padding: 15px 40px;
      font-size: 18px;
      font-weight: bold;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .restart-button:hover {
      background: #218838;
    }

    .hidden {
      display: none;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="container">
   <h1 id="system-title">Preposition Learning System</h1>
   <div class="subtitle">
    Interactive English Preposition Practice with Student Tracking
   </div><!-- Homepage -->
   <div id="homepage">
    <div class="nav-buttons"><button class="nav-button primary" onclick="showGame()">üéÆ Start Practice</button> <button class="nav-button secondary" onclick="showRecords()">üìä View Records</button> <button class="nav-button danger" onclick="clearAllRecords()">üóëÔ∏è Clear Records</button>
    </div>
    <div class="section">
     <h2>üìö Question Bank Overview</h2>
     <p>This system contains <strong>20 interactive questions</strong> covering 5 essential prepositions:</p>
     <div class="question-bank">
      <div class="preposition-group">
       <div class="preposition-title">
        ON (Âú®...‰∏äÈù¢)
       </div>
       <ul class="example-list">
        <li><span class="emoji">üçé</span> Put the apple ON the table <span class="chinese">Âú®Ê°åÂ≠ê‰∏ä</span></li>
        <li><span class="emoji">üì±</span> Put the phone ON the table <span class="chinese">Âú®Ê°åÂ≠ê‰∏ä</span></li>
        <li><span class="emoji">üç∞</span> Put the cake ON the table <span class="chinese">Âú®Ê°åÂ≠ê‰∏ä</span></li>
        <li><span class="emoji">üéÅ</span> Put the gift ON the table <span class="chinese">Âú®Ê°åÂ≠ê‰∏ä</span></li>
       </ul>
      </div>
      <div class="preposition-group">
       <div class="preposition-title">
        UNDER (Âú®...‰∏ãÈù¢)
       </div>
       <ul class="example-list">
        <li><span class="emoji">üìö</span> Put the book UNDER the table <span class="chinese">Âú®Ê°åÂ≠ê‰∏ãÈù¢</span></li>
        <li><span class="emoji">üê±</span> Put the cat UNDER the table <span class="chinese">Âú®Ê°åÂ≠ê‰∏ãÈù¢</span></li>
        <li><span class="emoji">üëü</span> Put the shoe UNDER the table <span class="chinese">Âú®Ê°åÂ≠ê‰∏ãÈù¢</span></li>
        <li><span class="emoji">üé©</span> Put the hat UNDER the table <span class="chinese">Âú®Ê°åÂ≠ê‰∏ãÈù¢</span></li>
       </ul>
      </div>
      <div class="preposition-group">
       <div class="preposition-title">
        LEFT (Âú®...Â∑¶ÈÇä)
       </div>
       <ul class="example-list">
        <li><span class="emoji">‚òï</span> Put the cup to the LEFT of the table <span class="chinese">Âú®Ê°åÂ≠êÂ∑¶ÈÇä</span></li>
        <li><span class="emoji">üß∏</span> Put the toy to the LEFT of the table <span class="chinese">Âú®Ê°åÂ≠êÂ∑¶ÈÇä</span></li>
        <li><span class="emoji">üåø</span> Put the plant to the LEFT of the table <span class="chinese">Âú®Ê°åÂ≠êÂ∑¶ÈÇä</span></li>
        <li><span class="emoji">‚úèÔ∏è</span> Put the pencil to the LEFT of the table <span class="chinese">Âú®Ê°åÂ≠êÂ∑¶ÈÇä</span></li>
       </ul>
      </div>
      <div class="preposition-group">
       <div class="preposition-title">
        RIGHT (Âú®...Âè≥ÈÇä)
       </div>
       <ul class="example-list">
        <li><span class="emoji">‚öΩ</span> Put the ball to the RIGHT of the table <span class="chinese">Âú®Ê°åÂ≠êÂè≥ÈÇä</span></li>
        <li><span class="emoji">üí°</span> Put the lamp to the RIGHT of the table <span class="chinese">Âú®Ê°åÂ≠êÂè≥ÈÇä</span></li>
        <li><span class="emoji">üëú</span> Put the bag to the RIGHT of the table <span class="chinese">Âú®Ê°åÂ≠êÂè≥ÈÇä</span></li>
        <li><span class="emoji">‚≠ê</span> Put the star to the RIGHT of the table <span class="chinese">Âú®Ê°åÂ≠êÂè≥ÈÇä</span></li>
       </ul>
      </div>
      <div class="preposition-group">
       <div class="preposition-title">
        IN (Âú®...Ë£°Èù¢)
       </div>
       <ul class="example-list">
        <li><span class="emoji">üå∏</span> Put the flower IN the drawer <span class="chinese">Âú®ÊäΩÂ±úË£°</span></li>
        <li><span class="emoji">üì¶</span> Put the box IN the drawer <span class="chinese">Âú®ÊäΩÂ±úË£°</span></li>
        <li><span class="emoji">‚è∞</span> Put the clock IN the drawer <span class="chinese">Âú®ÊäΩÂ±úË£°</span></li>
        <li><span class="emoji">üîë</span> Put the key IN the drawer <span class="chinese">Âú®ÊäΩÂ±úË£°</span></li>
       </ul>
      </div>
     </div>
    </div>
    <div class="section">
     <h2>üéØ How It Works</h2>
     <p><strong>For Students:</strong> Drag and drop objects to the correct positions based on the English instructions. Each question shows the preposition in <span style="color: #dc3545; font-weight: bold;">red</span> to help you focus on the key word.</p>
     <p><strong>For Teachers:</strong> All student answers are automatically recorded with timestamps. You can view detailed reports and clear records as needed.</p>
    </div>
   </div><!-- Records Page -->
   <div id="records-page" class="hidden">
    <div class="nav-buttons"><button class="nav-button primary" onclick="showHomepage()">üè† Back to Home</button> <button class="nav-button secondary" onclick="refreshRecords()">üîÑ Refresh</button> <button class="nav-button danger" onclick="clearAllRecords()">üóëÔ∏è Clear All Records</button>
    </div>
    <div class="section">
     <h2>üìä Student Performance Statistics</h2>
     <div class="stats-grid">
      <div class="stat-card">
       <div class="stat-number" id="total-attempts">
        0
       </div>
       <div class="stat-label">
        Total Attempts
       </div>
      </div>
      <div class="stat-card">
       <div class="stat-number" id="correct-answers">
        0
       </div>
       <div class="stat-label">
        Correct Answers
       </div>
      </div>
      <div class="stat-card">
       <div class="stat-number" id="accuracy-rate">
        0%
       </div>
       <div class="stat-label">
        Accuracy Rate
       </div>
      </div>
      <div class="stat-card">
       <div class="stat-number" id="total-students">
        0
       </div>
       <div class="stat-label">
        Active Sessions
       </div>
      </div>
     </div>
    </div>
    <div class="section">
     <h2>üìù Detailed Answer Records</h2>
     <div id="records-loading" class="loading">
      Loading records...
     </div>
     <div id="no-records" class="no-records hidden">
      No records found. Students haven't started practicing yet.
     </div>
     <table id="records-table" class="records-table hidden">
      <thead>
       <tr>
        <th>Time</th>
        <th>Question</th>
        <th>Object</th>
        <th>Correct Position</th>
        <th>Result</th>
        <th>Student Answer</th>
       </tr>
      </thead>
      <tbody id="records-tbody">
      </tbody>
     </table>
    </div>
   </div><!-- Game Page -->
   <div id="game-page" class="hidden">
    <div class="nav-buttons"><button class="nav-button primary" onclick="showHomepage()">üè† Back to Home</button>
    </div>
    <div class="score-board">
     <div class="score-item">
      <div class="score-label">
       Question
      </div>
      <div class="score-value">
       <span id="current-question">1</span> / 20
      </div>
     </div>
     <div class="score-item">
      <div class="score-label">
       Correct
      </div>
      <div class="score-value" id="correct-count">
       0
      </div>
     </div>
     <div class="score-item">
      <div class="score-label">
       Accuracy
      </div>
      <div class="score-value" id="accuracy">
       0%
      </div>
     </div>
    </div>
    <div id="game-content">
     <div class="question-area">
      <div class="question-text" id="question-text">
       Put the apple ON the table
      </div>
     </div>
     <div class="game-area" id="game-area">
      <div class="table"></div>
      <div class="drawer"></div>
      <div class="draggable-object" id="draggable">
       üçé
      </div>
     </div>
     <div class="feedback hidden" id="feedback"></div><button class="next-button" id="next-button" disabled>Next Question (Êåâ‰∏ãÁ©∫ÁôΩÈçµ)</button>
    </div>
    <div id="completion-screen" style="display: none;" class="completion-screen">
     <h2>üéâ Congratulations! üéâ</h2>
     <div class="final-score" id="final-score">
      20 / 20
     </div>
     <p style="font-size: 20px; color: #666;">You've completed all questions!</p><button class="restart-button" onclick="restartGame()">Play Again</button> <button class="nav-button primary" onclick="showHomepage()" style="margin-left: 20px;">Back to Home</button>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      system_title: "Preposition Learning System",
      teacher_name: "Teacher",
      primary_color: "#667eea",
      secondary_color: "#764ba2",
      text_color: "#333333",
      accent_color: "#ffd700",
      success_color: "#28a745"
    };

    const questions = [
      { text: "Put the apple ON the table", position: "on", emoji: "üçé", chinese: "Âú®Ê°åÂ≠ê‰∏ä" },
      { text: "Put the book UNDER the table", position: "under", emoji: "üìö", chinese: "Âú®Ê°åÂ≠ê‰∏ãÈù¢" },
      { text: "Put the cup to the LEFT of the table", position: "left", emoji: "‚òï", chinese: "Âú®Ê°åÂ≠êÂ∑¶ÈÇä" },
      { text: "Put the ball to the RIGHT of the table", position: "right", emoji: "‚öΩ", chinese: "Âú®Ê°åÂ≠êÂè≥ÈÇä" },
      { text: "Put the flower IN the drawer", position: "in", emoji: "üå∏", chinese: "Âú®ÊäΩÂ±úË£°" },
      { text: "Put the cat UNDER the table", position: "under", emoji: "üê±", chinese: "Âú®Ê°åÂ≠ê‰∏ãÈù¢" },
      { text: "Put the phone ON the table", position: "on", emoji: "üì±", chinese: "Âú®Ê°åÂ≠ê‰∏ä" },
      { text: "Put the toy to the LEFT of the table", position: "left", emoji: "üß∏", chinese: "Âú®Ê°åÂ≠êÂ∑¶ÈÇä" },
      { text: "Put the lamp to the RIGHT of the table", position: "right", emoji: "üí°", chinese: "Âú®Ê°åÂ≠êÂè≥ÈÇä" },
      { text: "Put the box IN the drawer", position: "in", emoji: "üì¶", chinese: "Âú®ÊäΩÂ±úË£°" },
      { text: "Put the cake ON the table", position: "on", emoji: "üç∞", chinese: "Âú®Ê°åÂ≠ê‰∏ä" },
      { text: "Put the shoe UNDER the table", position: "under", emoji: "üëü", chinese: "Âú®Ê°åÂ≠ê‰∏ãÈù¢" },
      { text: "Put the plant to the LEFT of the table", position: "left", emoji: "üåø", chinese: "Âú®Ê°åÂ≠êÂ∑¶ÈÇä" },
      { text: "Put the bag to the RIGHT of the table", position: "right", emoji: "üëú", chinese: "Âú®Ê°åÂ≠êÂè≥ÈÇä" },
      { text: "Put the clock IN the drawer", position: "in", emoji: "‚è∞", chinese: "Âú®ÊäΩÂ±úË£°" },
      { text: "Put the hat UNDER the table", position: "under", emoji: "üé©", chinese: "Âú®Ê°åÂ≠ê‰∏ãÈù¢" },
      { text: "Put the gift ON the table", position: "on", emoji: "üéÅ", chinese: "Âú®Ê°åÂ≠ê‰∏ä" },
      { text: "Put the pencil to the LEFT of the table", position: "left", emoji: "‚úèÔ∏è", chinese: "Âú®Ê°åÂ≠êÂ∑¶ÈÇä" },
      { text: "Put the star to the RIGHT of the table", position: "right", emoji: "‚≠ê", chinese: "Âú®Ê°åÂ≠êÂè≥ÈÇä" },
      { text: "Put the key IN the drawer", position: "in", emoji: "üîë", chinese: "Âú®ÊäΩÂ±úË£°" }
    ];

    let currentQuestionIndex = 0;
    let correctCount = 0;
    let hasAnswered = false;
    let draggedElement = null;
    let offsetX = 0;
    let offsetY = 0;
    let allRecords = [];

    // Data SDK Handler
    const dataHandler = {
      onDataChanged(data) {
        allRecords = data;
        updateRecordsDisplay();
      }
    };

    // Initialize Data SDK
    async function initDataSdk() {
      if (window.dataSdk) {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) {
          console.error("Failed to initialize data SDK");
        }
      }
    }

    // Navigation Functions
    function showHomepage() {
      document.getElementById('homepage').classList.remove('hidden');
      document.getElementById('records-page').classList.add('hidden');
      document.getElementById('game-page').classList.add('hidden');
    }

    function showRecords() {
      document.getElementById('homepage').classList.add('hidden');
      document.getElementById('records-page').classList.remove('hidden');
      document.getElementById('game-page').classList.add('hidden');
      refreshRecords();
    }

    function showGame() {
      document.getElementById('homepage').classList.add('hidden');
      document.getElementById('records-page').classList.add('hidden');
      document.getElementById('game-page').classList.remove('hidden');
      initGame();
    }

    // Records Functions
    function refreshRecords() {
      updateRecordsDisplay();
    }

    async function clearAllRecords() {
      if (allRecords.length === 0) {
        showCustomMessage("No records to clear!", "info");
        return;
      }

      const confirmDiv = document.createElement('div');
      confirmDiv.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        z-index: 1000; text-align: center; max-width: 400px;
      `;
      confirmDiv.innerHTML = `
        <h3 style="color: #dc3545; margin-bottom: 20px;">‚ö†Ô∏è Confirm Delete</h3>
        <p style="margin-bottom: 25px;">Are you sure you want to delete all ${allRecords.length} student records? This action cannot be undone.</p>
        <button onclick="executeDeleteAll()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin-right: 10px; cursor: pointer;">Delete All</button>
        <button onclick="cancelDelete()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Cancel</button>
      `;

      const backdrop = document.createElement('div');
      backdrop.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 999;
      `;
      backdrop.onclick = cancelDelete;

      document.body.appendChild(backdrop);
      document.body.appendChild(confirmDiv);

      window.executeDeleteAll = async function() {
        const deletePromises = allRecords.map(record => window.dataSdk.delete(record));
        await Promise.all(deletePromises);
        cancelDelete();
        showCustomMessage("All records deleted successfully!", "success");
      };

      window.cancelDelete = function() {
        document.body.removeChild(backdrop);
        document.body.removeChild(confirmDiv);
        delete window.executeDeleteAll;
        delete window.cancelDelete;
      };
    }

    function showCustomMessage(message, type) {
      const messageDiv = document.createElement('div');
      const bgColor = type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#d1ecf1';
      const textColor = type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#0c5460';
      
      messageDiv.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 1000;
        background: ${bgColor}; color: ${textColor}; padding: 15px 25px;
        border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        font-weight: bold; max-width: 300px;
      `;
      messageDiv.textContent = message;
      
      document.body.appendChild(messageDiv);
      setTimeout(() => document.body.removeChild(messageDiv), 3000);
    }

    function updateRecordsDisplay() {
      const loadingEl = document.getElementById('records-loading');
      const noRecordsEl = document.getElementById('no-records');
      const tableEl = document.getElementById('records-table');
      const tbodyEl = document.getElementById('records-tbody');

      loadingEl.classList.add('hidden');

      if (allRecords.length === 0) {
        noRecordsEl.classList.remove('hidden');
        tableEl.classList.add('hidden');
        updateStats(0, 0, 0);
        return;
      }

      noRecordsEl.classList.add('hidden');
      tableEl.classList.remove('hidden');

      // Update statistics
      const totalAttempts = allRecords.length;
      const correctAnswers = allRecords.filter(r => r.is_correct).length;
      const accuracyRate = totalAttempts > 0 ? Math.round((correctAnswers / totalAttempts) * 100) : 0;
      const uniqueSessions = new Set(allRecords.map(r => r.timestamp.split('T')[0])).size;

      updateStats(totalAttempts, correctAnswers, accuracyRate, uniqueSessions);

      // Update table
      tbodyEl.innerHTML = '';
      const sortedRecords = [...allRecords].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      
      sortedRecords.forEach(record => {
        const row = document.createElement('tr');
        const time = new Date(record.timestamp).toLocaleString();
        const resultClass = record.is_correct ? 'correct' : 'incorrect';
        const resultText = record.is_correct ? '‚úì Correct' : '‚úó Incorrect';
        
        row.innerHTML = `
          <td>${time}</td>
          <td>${record.question_text}</td>
          <td style="font-size: 20px;">${record.emoji}</td>
          <td><strong>${record.position.toUpperCase()}</strong></td>
          <td class="${resultClass}">${resultText}</td>
          <td>${record.student_answer || 'Unknown'}</td>
        `;
        tbodyEl.appendChild(row);
      });
    }

    function updateStats(total, correct, accuracy, sessions = 0) {
      document.getElementById('total-attempts').textContent = total;
      document.getElementById('correct-answers').textContent = correct;
      document.getElementById('accuracy-rate').textContent = accuracy + '%';
      document.getElementById('total-students').textContent = sessions;
    }

    // Game Functions
    function initGame() {
      currentQuestionIndex = 0;
      correctCount = 0;
      hasAnswered = false;
      document.getElementById('game-content').style.display = 'block';
      document.getElementById('completion-screen').style.display = 'none';
      loadQuestion();
      setupDragAndDrop();
    }

    function loadQuestion() {
      const question = questions[currentQuestionIndex];
      
      let questionText = question.text;
      const keywords = ['ON', 'UNDER', 'LEFT', 'RIGHT', 'IN'];
      keywords.forEach(keyword => {
        questionText = questionText.replace(new RegExp(`\\b${keyword}\\b`, 'g'), `<span style="color: #dc3545; font-weight: bold;">${keyword}</span>`);
      });
      
      document.getElementById('question-text').innerHTML = questionText;
      document.getElementById('draggable').textContent = question.emoji;
      document.getElementById('current-question').textContent = currentQuestionIndex + 1;
      document.getElementById('feedback').className = 'feedback hidden';
      document.getElementById('next-button').disabled = true;
      hasAnswered = false;

      const draggable = document.getElementById('draggable');
      draggable.style.left = '50px';
      draggable.style.top = '50px';
    }

    function setupDragAndDrop() {
      const draggable = document.getElementById('draggable');

      draggable.addEventListener('mousedown', startDrag);
      draggable.addEventListener('touchstart', startDrag);

      document.addEventListener('mousemove', drag);
      document.addEventListener('touchmove', drag);

      document.addEventListener('mouseup', endDrag);
      document.addEventListener('touchend', endDrag);
    }

    function startDrag(e) {
      if (hasAnswered) return;

      draggedElement = e.target;
      draggedElement.classList.add('dragging');

      const rect = draggedElement.getBoundingClientRect();
      const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
      const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;

      offsetX = clientX - rect.left;
      offsetY = clientY - rect.top;

      e.preventDefault();
    }

    function drag(e) {
      if (!draggedElement) return;

      const gameArea = document.getElementById('game-area');
      const rect = gameArea.getBoundingClientRect();

      const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
      const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;

      let x = clientX - rect.left - offsetX;
      let y = clientY - rect.top - offsetY;

      x = Math.max(0, Math.min(x, rect.width - 60));
      y = Math.max(0, Math.min(y, rect.height - 60));

      draggedElement.style.left = x + 'px';
      draggedElement.style.top = y + 'px';

      e.preventDefault();
    }

    function endDrag(e) {
      if (!draggedElement || hasAnswered) return;

      draggedElement.classList.remove('dragging');
      checkAnswer();
      draggedElement = null;
    }

    async function checkAnswer() {
      const question = questions[currentQuestionIndex];
      const draggable = document.getElementById('draggable');
      const table = document.querySelector('.table');
      const drawer = document.querySelector('.drawer');

      const draggableRect = draggable.getBoundingClientRect();
      const tableRect = table.getBoundingClientRect();
      const drawerRect = drawer.getBoundingClientRect();

      const draggableCenterX = draggableRect.left + draggableRect.width / 2;
      const draggableCenterY = draggableRect.top + draggableRect.height / 2;

      let isCorrect = false;
      let studentAnswer = 'unknown';

      if (question.position === 'on') {
        if (draggableCenterY < tableRect.bottom && draggableCenterY > tableRect.top - 40 &&
            draggableCenterX > tableRect.left && draggableCenterX < tableRect.right) {
          isCorrect = true;
          studentAnswer = 'on';
        } else if (draggableCenterY > tableRect.bottom && draggableCenterY < tableRect.bottom + 100 &&
                   draggableCenterX > tableRect.left && draggableCenterX < tableRect.right) {
          studentAnswer = 'under';
        } else if (draggableCenterX < tableRect.left - 20) {
          studentAnswer = 'left';
        } else if (draggableCenterX > tableRect.right + 20) {
          studentAnswer = 'right';
        } else if (draggableCenterX > drawerRect.left && draggableCenterX < drawerRect.right &&
                   draggableCenterY > drawerRect.top && draggableCenterY < drawerRect.bottom) {
          studentAnswer = 'in';
        }
      } else if (question.position === 'under') {
        if (draggableCenterY > tableRect.bottom && draggableCenterY < tableRect.bottom + 100 &&
            draggableCenterX > tableRect.left && draggableCenterX < tableRect.right) {
          isCorrect = true;
          studentAnswer = 'under';
        } else if (draggableCenterY < tableRect.bottom && draggableCenterY > tableRect.top - 40 &&
                   draggableCenterX > tableRect.left && draggableCenterX < tableRect.right) {
          studentAnswer = 'on';
        } else if (draggableCenterX < tableRect.left - 20) {
          studentAnswer = 'left';
        } else if (draggableCenterX > tableRect.right + 20) {
          studentAnswer = 'right';
        } else if (draggableCenterX > drawerRect.left && draggableCenterX < drawerRect.right &&
                   draggableCenterY > drawerRect.top && draggableCenterY < drawerRect.bottom) {
          studentAnswer = 'in';
        }
      } else if (question.position === 'left') {
        if (draggableCenterX < tableRect.left - 20 &&
            draggableCenterY > tableRect.top - 50 && draggableCenterY < tableRect.bottom + 50) {
          isCorrect = true;
          studentAnswer = 'left';
        } else if (draggableCenterX > tableRect.right + 20) {
          studentAnswer = 'right';
        } else if (draggableCenterY < tableRect.bottom && draggableCenterY > tableRect.top - 40 &&
                   draggableCenterX > tableRect.left && draggableCenterX < tableRect.right) {
          studentAnswer = 'on';
        } else if (draggableCenterY > tableRect.bottom && draggableCenterY < tableRect.bottom + 100 &&
                   draggableCenterX > tableRect.left && draggableCenterX < tableRect.right) {
          studentAnswer = 'under';
        } else if (draggableCenterX > drawerRect.left && draggableCenterX < drawerRect.right &&
                   draggableCenterY > drawerRect.top && draggableCenterY < drawerRect.bottom) {
          studentAnswer = 'in';
        }
      } else if (question.position === 'right') {
        if (draggableCenterX > tableRect.right + 20 &&
            draggableCenterY > tableRect.top - 50 && draggableCenterY < tableRect.bottom + 50) {
          isCorrect = true;
          studentAnswer = 'right';
        } else if (draggableCenterX < tableRect.left - 20) {
          studentAnswer = 'left';
        } else if (draggableCenterY < tableRect.bottom && draggableCenterY > tableRect.top - 40 &&
                   draggableCenterX > tableRect.left && draggableCenterX < tableRect.right) {
          studentAnswer = 'on';
        } else if (draggableCenterY > tableRect.bottom && draggableCenterY < tableRect.bottom + 100 &&
                   draggableCenterX > tableRect.left && draggableCenterX < tableRect.right) {
          studentAnswer = 'under';
        } else if (draggableCenterX > drawerRect.left && draggableCenterX < drawerRect.right &&
                   draggableCenterY > drawerRect.top && draggableCenterY < drawerRect.bottom) {
          studentAnswer = 'in';
        }
      } else if (question.position === 'in') {
        if (draggableCenterX > drawerRect.left && draggableCenterX < drawerRect.right &&
            draggableCenterY > drawerRect.top && draggableCenterY < drawerRect.bottom) {
          isCorrect = true;
          studentAnswer = 'in';
        } else if (draggableCenterY < tableRect.bottom && draggableCenterY > tableRect.top - 40 &&
                   draggableCenterX > tableRect.left && draggableCenterX < tableRect.right) {
          studentAnswer = 'on';
        } else if (draggableCenterY > tableRect.bottom && draggableCenterY < tableRect.bottom + 100 &&
                   draggableCenterX > tableRect.left && draggableCenterX < tableRect.right) {
          studentAnswer = 'under';
        } else if (draggableCenterX < tableRect.left - 20) {
          studentAnswer = 'left';
        } else if (draggableCenterX > tableRect.right + 20) {
          studentAnswer = 'right';
        }
      }

      // Save to database
      if (window.dataSdk) {
        const record = {
          question_index: currentQuestionIndex,
          question_text: question.text,
          position: question.position,
          emoji: question.emoji,
          is_correct: isCorrect,
          timestamp: new Date().toISOString(),
          student_answer: studentAnswer
        };

        const result = await window.dataSdk.create(record);
        if (!result.isOk) {
          console.error("Failed to save record");
        }
      }

      hasAnswered = true;
      const feedback = document.getElementById('feedback');

      if (isCorrect) {
        correctCount++;
        feedback.className = 'feedback correct';
        feedback.innerHTML = `<div>‚úì Correct! Great job!</div>`;
      } else {
        feedback.className = 'feedback incorrect';
        feedback.innerHTML = `
          <div>‚úó Not quite right. The correct answer is:</div>
          <div class="chinese-answer">${question.text.toUpperCase()} (${question.chinese})</div>
        `;
      }

      updateScore();
      document.getElementById('next-button').disabled = false;
    }

    function updateScore() {
      document.getElementById('correct-count').textContent = correctCount;
      const accuracy = Math.round((correctCount / (currentQuestionIndex + 1)) * 100);
      document.getElementById('accuracy').textContent = accuracy + '%';
    }

    function nextQuestion() {
      currentQuestionIndex++;

      if (currentQuestionIndex >= questions.length) {
        showCompletionScreen();
      } else {
        loadQuestion();
      }
    }

    function showCompletionScreen() {
      document.getElementById('game-content').style.display = 'none';
      document.getElementById('completion-screen').style.display = 'block';
      document.getElementById('final-score').textContent = `${correctCount} / ${questions.length}`;
    }

    function restartGame() {
      initGame();
    }

    // Event Listeners
    document.getElementById('next-button').addEventListener('click', nextQuestion);

    document.addEventListener('keydown', function(e) {
      if (e.code === 'Space' && !document.getElementById('next-button').disabled) {
        e.preventDefault();
        nextQuestion();
      }
    });

    // Element SDK Configuration
    async function onConfigChange(config) {
      const systemTitle = config.system_title || defaultConfig.system_title;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const accentColor = config.accent_color || defaultConfig.accent_color;
      const successColor = config.success_color || defaultConfig.success_color;

      document.getElementById('system-title').textContent = systemTitle;
      document.querySelector('h1').style.color = primaryColor;
      document.querySelectorAll('.score-value').forEach(el => el.style.color = primaryColor);
      document.querySelector('.question-area').style.borderColor = accentColor;
      document.querySelector('.next-button').style.background = primaryColor;
      document.querySelector('.restart-button').style.background = successColor;
      document.querySelector('body').style.background = `linear-gradient(135deg, ${primaryColor} 0%, ${config.secondary_color || defaultConfig.secondary_color} 100%)`;
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: (config) => ({
          recolorables: [
            {
              get: () => config.primary_color || defaultConfig.primary_color,
              set: (value) => {
                config.primary_color = value;
                window.elementSdk.setConfig({ primary_color: value });
              }
            },
            {
              get: () => config.secondary_color || defaultConfig.secondary_color,
              set: (value) => {
                config.secondary_color = value;
                window.elementSdk.setConfig({ secondary_color: value });
              }
            },
            {
              get: () => config.accent_color || defaultConfig.accent_color,
              set: (value) => {
                config.accent_color = value;
                window.elementSdk.setConfig({ accent_color: value });
              }
            },
            {
              get: () => config.success_color || defaultConfig.success_color,
              set: (value) => {
                config.success_color = value;
                window.elementSdk.setConfig({ success_color: value });
              }
            }
          ],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ["system_title", config.system_title || defaultConfig.system_title],
          ["teacher_name", config.teacher_name || defaultConfig.teacher_name]
        ])
      });
    }

    // Initialize
    initDataSdk();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99a3151f33b34a61',t:'MTc2MjQxNjI5Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
